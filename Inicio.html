<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday</title>

    <!--Estilos-->
    <link rel="stylesheet" href="assets/fonts/fontawesome-free-6.1.2-web/css/all.min.css">
    <link rel="stylesheet" href="assets/fonts/poppins/poppins.css">
    <link rel="stylesheet" href="assets/css/reset.css">
    <link rel="stylesheet" href="assets/css/styles.css">

  </head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
              <img src="assets/img/logo.svg" alt="">
            </div>
            <nav class="menu">
              <ul>
                <li><a href="Inicio.html">Inicio</a></li>
                <li><a href="cheack.html">Check</a></li>
                <li><a href="comedor.html">Comedor</a></li>
                <li><a href="menu.html">Empleados</a></li>
                <li><a href="anuncios.html">Anuncios</a></li>
              </ul>
            </nav>
        </aside>
  
        <!-- Main Content -->
        <div class="main-content">
            <header class="top-bar">
                <!-- HTML -->
                <div class="user-info">
                  <button class="user-button" id="userMenuButton">
                    Hola Iban Loeza <span class="dropdown-icon">▼</span>
                  </button>
                  <div class="none"></div>
                  <div class="dropdown-menu hidden" id="userDropdown">
                    <a href="Perfil.html"><img src="assets/img/reader.svg" alt="reader"> Perfil</a>
                    <a href="#"><img src="assets/img/money.svg" alt="money"> Pagos</a>
                    <a href="index.html"><img src="assets/img/Logout.svg" alt="logout"> Cerrar sesión</a>
                  </div>
                </div>
                         
                
                <div class="notifications">
                        <div class="notification-bell">
                          <img src="assets/img/Bell.svg" alt="bell" class="noti">
                          <img src="assets/img/Ellipse 4.svg" alt="ellipse">
                        </div>
                        <span class="notification-count">13</span>
                      </div>
                    </header>

                    <div class="container3">
                      <h2>Inicio</h2>
              
                      <div class="progress-container">
                        <div class="progress-labels">
                            <span><h3 style="font-size: 20px; color: #1F4B79;">Asistencia General</h3></span>
                            <span>
                                <span id="totalPresentes" style="color: #28a745; font-size: 18px;">0 presentes</span> 
                                <span id="totalAusentes" style="color: red; font-size: 18px; margin-left: 16px;">0 ausentes</span>
                            </span>
                        </div>
                        <div class="progress-bar">
                            <div id="progressBarGeneral" class="progress-fill">
                                <span id="porcentajeGeneral" class="progress-text">0%</span>
                            </div>
                        </div>
                    </div>
            
                    <div class="circles-container">
                        <!-- Administración -->
                        <div class="circle">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" stroke="#ddd" stroke-width="10" fill="none"/>
                                <circle id="circleAdmin" class="progress-circle" cx="60" cy="60" r="50" stroke="#1F4B79" stroke-width="10" fill="none"/>
                            </svg>
                            <div id="porcentajeAdmin" class="circle-text">0%</div>
                            <div class="circle-label">Administración</div>
                            <div class="circle-details">
                                <span id="presentesAdmin" style="color: #28a745">0 presentes</span>
                                <span id="ausentesAdmin" style="color: red">0 ausentes</span>
                            </div>
                        </div>
            
                        <!-- Mantenimiento -->
                        <div class="circle">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" stroke="#ddd" stroke-width="10" fill="none"/>
                                <circle id="circleMant" class="progress-circle" cx="60" cy="60" r="50" stroke="#28a745" stroke-width="10" fill="none"/>
                            </svg>
                            <div id="porcentajeMant" class="circle-text">0%</div>
                            <div class="circle-label">Mantenimiento</div>
                            <div class="circle-details">
                                <span id="presentesMant" style="color: #28a745">0 presentes</span>
                                <span id="ausentesMant" style="color: red">0 ausentes</span>
                            </div>
                        </div>
            
                        <!-- Recepción -->
                        <div class="circle">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" stroke="#ddd" stroke-width="10" fill="none"/>
                                <circle id="circleRecep" class="progress-circle" cx="60" cy="60" r="50" stroke="#FFA500" stroke-width="10" fill="none"/>
                            </svg>
                            <div id="porcentajeRecep" class="circle-text">0%</div>
                            <div class="circle-label">Recepción</div>
                            <div class="circle-details">
                                <span id="presentesRecep" style="color: #28a745">0 presentes</span>
                                <span id="ausentesRecep" style="color: red">0 ausentes</span>
                            </div>
                        </div>

                        <!-- Recursos Humanos -->
                        <div class="circle">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" stroke="#ddd" stroke-width="10" fill="none"/>
                                <circle id="circleRH" class="progress-circle" cx="60" cy="60" r="50" stroke="#9C27B0" stroke-width="10" fill="none"/>
                            </svg>
                            <div id="porcentajeRH" class="circle-text">0%</div>
                            <div class="circle-label">Recursos Humanos</div>
                            <div class="circle-details">
                                <span id="presentesRH" style="color: #28a745">0 presentes</span>
                                <span id="ausentesRH" style="color: red">0 ausentes</span>
                            </div>
                        </div>

                        <!-- Sistemas -->
                        <div class="circle">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" stroke="#ddd" stroke-width="10" fill="none"/>
                                <circle id="circleSistemas" class="progress-circle" cx="60" cy="60" r="50" stroke="#2196F3" stroke-width="10" fill="none"/>
                            </svg>
                            <div id="porcentajeSistemas" class="circle-text">0%</div>
                            <div class="circle-label">Sistemas</div>
                            <div class="circle-details">
                                <span id="presentesSistemas" style="color: #28a745">0 presentes</span>
                                <span id="ausentesSistemas" style="color: red">0 ausentes</span>
                            </div>
                        </div>

                        <!-- Contabilidad -->
                        <div class="circle">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" stroke="#ddd" stroke-width="10" fill="none"/>
                                <circle id="circleContabilidad" class="progress-circle" cx="60" cy="60" r="50" stroke="#FF5722" stroke-width="10" fill="none"/>
                            </svg>
                            <div id="porcentajeContabilidad" class="circle-text">0%</div>
                            <div class="circle-label">Contabilidad</div>
                            <div class="circle-details">
                                <span id="presentesContabilidad" style="color: #28a745">0 presentes</span>
                                <span id="ausentesContabilidad" style="color: red">0 ausentes</span>
                            </div>
                        </div>

                        <!-- Ventas -->
                        <div class="circle">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" stroke="#ddd" stroke-width="10" fill="none"/>
                                <circle id="circleVentas" class="progress-circle" cx="60" cy="60" r="50" stroke="#4CAF50" stroke-width="10" fill="none"/>
                            </svg>
                            <div id="porcentajeVentas" class="circle-text">0%</div>
                            <div class="circle-label">Ventas</div>
                            <div class="circle-details">
                                <span id="presentesVentas" style="color: #28a745">0 presentes</span>
                                <span id="ausentesVentas" style="color: red">0 ausentes</span>
                            </div>
                        </div>

                        <script>
                            document.addEventListener('DOMContentLoaded', async function() {
                                let token = localStorage.getItem('authToken');
                                
                                if (!token) {
                                    token = await getAuthToken();
                                    if (!token) {
                                        console.error('No se pudo obtener el token de autenticación');
                                        return;
                                    }
                                }

                                async function actualizarGraficas() {
                                    try {
                                        const response = await fetch('https://devmace.onrender.com/api/securityBooth/attendance/summary', {
                                            method: 'GET',
                                            headers: {
                                                'Authorization': `Bearer ${token}`,
                                                'Content-Type': 'application/json'
                                            }
                                        });

                                        if (!response.ok) {
                                            if (response.status === 401) {
                                                token = await getAuthToken();
                                                if (!token) throw new Error('Error de autenticación');
                                                return actualizarGraficas();
                                            }
                                            throw new Error(`HTTP error! status: ${response.status}`);
                                        }

                                        const data = await response.json();
                                        console.log('Datos recibidos:', data);

                                        // Actualizar estadísticas generales
                                        const totalEmpleados = data.totalEmployees || 0;
                                        const totalPresentes = data.totalPresent || 0;
                                        const porcentajeGeneral = ((totalPresentes / totalEmpleados) * 100).toFixed(1);
                                        
                                        document.getElementById('totalPresentes').textContent = `${totalPresentes} presentes`;
                                        document.getElementById('totalAusentes').textContent = `${totalEmpleados - totalPresentes} ausentes`;
                                        document.getElementById('porcentajeGeneral').textContent = `${porcentajeGeneral}%`;
                                        document.getElementById('progressBarGeneral').style.width = `${porcentajeGeneral}%`;

                                        // Actualizar cada departamento
                                        const departamentos = {
                                            'Admin': 'admin',
                                            'Mant': 'mant',
                                            'Recep': 'recep',
                                            'RH': 'rh',
                                            'Sistemas': 'sistemas',
                                            'Contabilidad': 'contabilidad',
                                            'Ventas': 'ventas'
                                        };
                                        
                                        Object.entries(departamentos).forEach(([depto, apiKey]) => {
                                            const stats = data.departmentStats?.[apiKey];
                                            if (stats) {
                                                const porcentaje = ((stats.present / stats.total) * 100).toFixed(1);
                                                const circle = document.getElementById(`circle${depto}`);
                                                const circumference = 2 * Math.PI * 50;
                                                const offset = circumference - (porcentaje / 100 * circumference);
                                                
                                                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                                                circle.style.strokeDashoffset = offset;
                                                
                                                document.getElementById(`porcentaje${depto}`).textContent = `${porcentaje}%`;
                                                document.getElementById(`presentes${depto}`).textContent = `${stats.present} presentes`;
                                                document.getElementById(`ausentes${depto}`).textContent = `${stats.total - stats.present} ausentes`;
                                            }
                                        });
                                    } catch (error) {
                                        console.error('Error al actualizar las gráficas:', error);
                                    }
                                }

                                // Primera actualización
                                await actualizarGraficas();

                                // Actualizar cada 5 minutos
                                setInterval(actualizarGraficas, 300000);
                            });
                        </script>
                    </div>
                  </div>
            
            
        </div>
    </div>
    <script src="assets/js/script.js"></script>
  </body>
  
</html>